## 去除python运行环境等不必要依赖
本项目所用的图像识别基于是由mediapipe人工智能模型实现，不可避免地使用了python代码， 而python运行环境需要额外耗费不少资源，同时字节码本身有着运行速率的缺陷。
我们将Python脚本重写为CPython代码， 去除了不必要的依赖， 借助pyinstaller 工具将media pipe OpenCV等模块直接编译为动态链接库（.dll.so）去除了对 Python运行时环境的依赖，用机器指令替代了字节码， 大幅降低了运行所需的计算资源.

## **虚拟形像(Avatar)**的姿态控制

虚拟形像尤其是人形的姿态实时控制一直是此领域的一大重点和难点。为避免出现人体姿不自然甚至严重反常（例如，关节反向弯­曲，过度伸缩）之类问题本项目充分研究了 IK/FK（详见下文）设计并实现了骨骼驱动算法。
[IK/FK](./Difference-Between-IK-and-FK.jpg)
基本概念：
**FK(forward Kinematics)**正向动力学（根据父关节计算子关节的位置）
**IK (inverse Kinematics)**反向动力学（根据末端子关节的位置移动来计算得出每个父关节的旋转）
本项目主要根据识别处理所得的人体各节点的位置信息计算并控制虚拟形像的姿态（关节的弯曲等）大量应用了IK技术。
IK问题可能有一个解、多个解或无解。
[3fIKFK](./3f-IKFK.jpg)
IK问题解决有两步比较重要：

一：分析目标是可达还是不可达。检查目标是否在可达范围内是很重要的，因为避免寻找不存在的解决方案，可以节省大量的处理时间。末端受动器能够到达的目标空间称为可达工作空间。
二：当存在解决方案且没有达到解决方案时，需要添加终止条件来避免在迭代过程中进入无限循环的情况。比如：限制迭代次数、当末端受动器在前一次迭代和当前迭代时的位置差小于指定的公差时终止IK解算器（IK solvers）的计算。
要令IK发挥最好的效果，开始时骨骼最好摆出接近目标的姿势。这样有助于算法专注最接近的解，并能在合理的时间内完成计算。可用解的数量取决于目标位置或运动链的自由度。目标不可达的IK问题被称为过度约束问题。当目标可达时，两个或多个链可能存在多个解决方案。这使得IK问题不受约束（或冗余）——它可能有无限多的解决方案来满足期望的目标。

IK求解算法
IK解算器主要分为四大类，分别是解析法（the Analytic family）、数值法（the Numerical family）、数据驱动法（Data-driven methods）和混合法（the Hybrid family of solvers）。

### 生物力学约束（Biomechanical constraints）
在冗余系统中，寻求IK解决方案时，结合关节约束来选择满足用户/模型约束的解决方案是必要的。有很多关节和模型约束已经被提出。

第一组约束基于高级控制，如位置、方向、特定视觉和平衡。
第二组约束，目标由用户定义或依赖于环境，如在交互任务（地板、到达、抓取）中或在碰撞避免中。同时执行多项任务可能会导致目标冲突，所以IK结算器可以使用优先级或加权方法来控制，然后在不同的情况下找到不同的解决方案。
关节由位置和方向定义，在普通情况下，它有3个自由度。关节允许连接在一起的两个肢体之间进行相对运动。人体测量关节也有多种，比如：球窝、铰链等。大多数现有的结构模型使用的技术是限制关节的旋转和平移限制。通过限制关节运动，可以保持运动在可行的范围内，以防止出现不现实、非自然的运动。

即使考虑到关节的极限，仍然可能得到非自然的姿势。还需要下面的方案来保证动作自然性：

由于IK不能直接解决动力学约束，如弹道运动中的动量守恒问题，所以人们进行了很多努力。使用基于物理的角色动画来为IK结算器提供一个更自然的运动，保持在一个可行的运动集里。物理相关的技术有很多，比如：利用动量和惯性来改善动画平衡；利用某些动态物理特性，如质心和角动量，来改善不现实的运动；使用动量和力约束；通过控制质量中心和角色惯性张量的大小，在特定的动态活动中尊重物理。
以肌肉为基础的控制方法。
结合数据驱动的方法。代价是训练学习大量复杂和动态的动作，这是很耗时的。

### **类人角色（Human-like characters）**
类人角色是计算机图形学中最常用的模型。一般来说，这种特征由大量的关节（至少 24 个）组成，这些关节受到生物力学和生理学的限制，最多有 70个DoFs。人们已经提出了许多解决方案来处理人类运动的high articulation。

雅可比矩阵方法：用于类人动画的第一方法是基于雅可比矩阵的方法。雅可比矩阵方法可以轻松处理人体骨骼的high articulation，但它们通常会产生不连续的抖动和不平稳的运动，尤其是当线性近似的clamping允许目标和末端受动器之间有较大的步幅时，或者当四肢接近单一姿势。减小clamping步骤的振幅提高了它们的稳定性，但代价是较高的计算时间。总而言之，在没有急速收敛的情况下跟踪目标所需的时间是有限制的；例如，DLS和SDLS方法在抖动和奇异性问题方面表现良好，但计算量大，因此在控制或与类人角色交互方面不太受欢迎。

启发式法：在启发式迭代方法中，通过跟踪附加在特定位置（如末端受动器）的多个控制点来为类人角色设置动画。启发式方法的问题是在确保附近关节之间的时空相关性得到满足方面的能力有限。即使应用了关节约束，并非所有生成的姿势都符合自然人体运动的生理约束。这主要是由于启发式方法在每次迭代时局部应用约束，每个关节都是独立处理的，不提供整合全局约束的可能性。从全局角度处理不自然姿势产生的一种方法是将骨架划分为sub-chains，并根据优先级按层次和顺序工作，以及研究关节之间的时间相关性，然后允许通过拉力进一步控制运动。

混合方法：在层次结构模型中结合数值和解析技术的混合方法可用于需要低计算成本和寻求约束良好的类人模型的任务。CCD和混合方法（SIK）在计算上比其他方法更有效，而在重建质量方面，SIK方法在评估中使用的方法中给出了最好的结果。然而，即使对于定义明确的模型，也很难理解如何应用全局限制（如基于物理或生理的限制）。因此，不能保证解算器返回的解会在一组可行的人类自然运动范围内。

数值驱动法：当前控制和动画类人角色的趋势是使用data-driven的学习或深度学习方法。学习方法选择从数据库获得的满足给定约束的最接近的候选姿势；它们的优点是不需要将约束集成到解算器中，因为重建的姿势仅与可行的姿势匹配。这确保了生成的姿势是自然的，并满足人体骨骼的解剖和生理约束。然而，数据驱动的方法需要一个离线学习阶段，结果的质量取决于所使用的运动数据库的大小。在真实姿势与存储的姿势范围不同的情况下，可能会产生异常解决方案。在数据库中建立大量可用的motion clips克服了这个问题，但从可用的姿势中选择最合适的姿势并非易事。还有许多其他因素会影响数据驱动方法的性能，例如确保时间一致性和所选姿态之间平滑过渡的机制。此外，不能保证从匹配的姿势中检索到的最佳候选不包含由于错误捕获而导致的错误。另一方面，深度学习方法可以处理错误问题；他们使用预先捕获的运动，通过卷积学习运动流形，平滑误差，从而重建自然和合理的运动。然而，与学习方法类似，学习CNN模型非常耗时，所产生运动的质量与用于训练的数据量相关。当通过卷积过程平滑运动时，它会插入运动的精细细节。尽管如此，学习和深度学习方法似乎都是目前最流行的方法之一，用于控制人体姿势和从稀疏数据中重建运动以及为高度关节化的人体部位（例如手）设置动画。

即使在处理类人角色时，数据驱动的方法也并不总是合适的。在某些情况下，导演希望他们的角色拥有卡通形象和行为或拥有超级英雄的能力。无法大规模捕获此类运动，来建立一个方便的运动库以用于检索所需的姿势。在这种情况下，有必要通过定义以分层和顺序方式运行的良好约束的混合解决方案来替代方法。此外，数据驱动的方法在计算上不够高效，无法实现实时交互。
### 算法设计
算法的输入： 若干定义的人体位置结点的三维坐标。

[body](./body.jpg)
以往在采用绝对坐标时，使用者身材差异（身高、体重等）带来数据浮动，输入数据会因为过大或过小，超出合理的取值范围。
此算法的创新性的运用相对化，位似化处理，即选定中心点（常选脖胫，躯干作为中心）计算其他各结点坐标相对于中心结点坐标的相对比例，
以相对比例来作为有效数据， 整体的扩大或者缩小都不会对结果产生影响。 实际上达到了相对于中心点位似的数据相互等价。借助数学手­段高效迅捷地消除了用户体型差异带来的影响。
算法思路：
人体各子关节相对于父关节（例如手臂相对于关节）在三维空间中有两个旋转自由度，实际上人体关节的转动有一定的范围，并不是 无限制的自由转动，在程序上反映为两个角度变量的值需满足一定的约束条件。 约束条件由生物力学和类人角色运动限制给出。
在以上条件和输入下运用IK求解算法求得各个关节点的转动弯曲情况。
根据解析结果驱动虚拟形象骨骼的转动弯曲。控制虚拟形象作者对应动作。


## UI设计和用户引导：
对于入门级用户：
[start](./start.png)
我们精心调整设计了默认状态，只宰点击"start"按扭，即可。将程序将自行适配本地环境，无须用户做进一步操作。
同样，退出时，亦只需点击"End"按扭，程序会自行清理的打工的其它关联程序和文件。
[end](./end.png)
对于专业级用户：
我们额外准备了， 设置界面， 可以对帧数、 分辨率、 识别频率、 虚拟形像(Avatar)的相关参数作进一步调整。